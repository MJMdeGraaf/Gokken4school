<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Goksite PWS ‚Äî Multiplayer Blackjack</title>
  <style>
    /* ============================
       LEADERBOARD TAB STYLE
       ============================ */
    #lb-tab{
        position: fixed;
        right: 20px;
        bottom: 20px;
        background: gold;
        padding: 12px 20px;
        border-radius: 16px;
        cursor: pointer;
        font-weight: bold;
        box-shadow: 0 0 10px rgba(0,0,0,0.4);
        z-index: 9999;
    }

    /* ============================
       POPUP WINDOW
       ============================ */
    #lb-popup{
        position: fixed;
        bottom: 0;
        right: 0;
        width: 360px;
        height: 460px;
        background: rgba(0,0,0,0.88);
        border-radius: 20px 0 0 0;
        display: none;
        z-index: 99999;
        color: white;
    }

    #lb-popup-inner{
        padding: 18px;
        height: 100%;
        position: relative;
    }

    /* ============================
       ARROWS
       ============================ */
    .lb-arrow{
        position: absolute;
        top: 12px;
        font-size: 26px;
        cursor: pointer;
        user-select: none;
    }
    #lb-left{ left: 10px; }
    #lb-right{ right: 10px; }

    /* ============================
       CONTENT AREA
       ============================ */
    #lb-content{
        margin-top: 52px;
        height: 330px;
        overflow-y: auto;
        font-size: 16px;
    }

    #lb-close{
        position: absolute;
        bottom: 14px;
        left: 50%;
        transform: translateX(-50%);
        padding: 8px 20px;
        border-radius: 10px;
        cursor: pointer;
    }

    /* ============================
       Music menu style
       ============================ */
    #musicMenu{
      position: fixed;
      right: 20px;
      bottom: 70px;
      width: 300px;
      background: rgba(0,0,0,0.92);
      color: white;
      padding: 15px;
      border-radius: 12px;
      display: none;
      z-index: 99999;
    }

    #musicMenuInner{
      text-align: center;
    }

    #musicMenu input[type=range]{
      width: 80%;
    }

    /* ============================
       Rest of page
       ============================ */
    body { margin:0; font-family: system-ui, sans-serif; }
    /* Dashboard Hoofdmenu */
    #login, #dashboard, #blackjackSection { display: none; padding: 20px; text-align:center; }
    #login { background: #f0f0f0; height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center; gap:8px; }
    #dashboard { background: linear-gradient(to bottom, #ffffff, #e0e0e0); height:100vh; }
    #dashboard h2, #login h2 { margin-bottom:10px; }
    button { padding: 10px 14px; margin: 6px; border-radius: 8px; border:none; cursor:pointer; }

    /* Blackjack sectie */
    #blackjackSection { background: #2f1e0f; height:100vh; color:white; }
    .table-container { position:relative; width: 90%; max-width: 900px; margin: 36px auto; height:520px; }
    .table { background: #8b5a2b; border-radius: 50%; width:100%; height:100%; position:relative; }
    .player-area { position:absolute; text-align:center; color: white; }
    .cards { display:flex; justify-content:center; gap:8px; margin-top:8px; }
    .card-bj { width:80px; height:120px; background:white; color:black; border-radius:6px; display:flex; justify-content:center; align-items:center; font-weight:bold; }
    .chair { width:40px; height:40px; background:#333; border-radius:50%; position:absolute; box-shadow:inset 0 -4px 6px rgba(0,0,0,0.4); }
    #controls { margin-top:20px; }

    /* small responsive */
    @media (max-width:600px){
      #lb-popup { width: 100%; right:0; left:0; height: 50vh; border-radius: 12px 12px 0 0;}
      .card-bj{ width:56px; height:84px; }
      .table-container{ height:360px; }
    }
  </style>
</head>
<body>

  <!-- Login / Account aanmaken -->
  <section id="login">
    <h2>Welkom! Maak een account of log in</h2>
    <input type="text" id="usernameInput" placeholder="Gebruikersnaam">
    <input type="password" id="passwordInput" placeholder="Wachtwoord">
    <button id="createAccountBtn">Account aanmaken</button>
    <button id="loginBtn">Inloggen</button>
    <input type="password" id="passwordInput" placeholder="Wachtwoord">

  </section>

  <!-- Dashboard -->
  <section id="dashboard">
    <h2>Welkom, <span id="displayName"></span></h2>
    <p>Credits: <span id="credits"></span></p>
    <button id="claimDailyBtn">Claim dagelijkse bonus</button><br>
    <button id="playBlackjackBtn">Speel Blackjack</button>
    <button id="openLeaderboardsBtn">Leaderboards</button>
    <button id="logoutBtn">Uitloggen</button>

    <!-- Music control -->
    <div style="margin-top:12px;">
      <audio id="bgMusic" loop>
        <source src="https://cdn.pixabay.com/audio/2023/03/07/audio_2ea36d1deb.mp3" type="audio/mpeg">
        <source src="https://cdn.pixabay.com/audio/2023/03/15/audio_e3bbcbfce7.mp3" type="audio/mpeg">
        <source src="https://cdn.pixabay.com/audio/2022/03/15/audio_8f17fc4b42.mp3" type="audio/mpeg">
      </audio>
      <button id="musicControl">üéµ Muziek</button>
    </div>
  </section>

  <!-- Blackjack -->
  <section id="blackjackSection">
    <h2>Blackjack</h2>
    <div>
      <label>Kies aantal bots:</label>
      <select id="botCount">
        <option value="0">0 bots</option>
        <option value="1">1 bot</option>
        <option value="2">2 bots</option>
        <option value="3">3 bots</option>
        <option value="4">4 bots</option>
        <option value="5">5 bots</option>
        <option value="6">6 bots</option>
        <option value="7">7 bots</option>
      </select>
      <button id="startGame">Start spel</button>
      <button id="backToMenu">Terug naar menu</button>
    </div>
    <div class="table-container">
      <div class="table" id="table">
        <!-- Stoelen + spelergebieden komen hier dynamisch -->
      </div>
    </div>
    <div id="controls">
      <button id="hitBtn">Hit</button>
      <button id="standBtn">Stand</button>
      <button id="nextRoundBtn" style="display:none">Volgende ronde</button>
    </div>
  </section>

  <!-- Leaderboard floating tab -->
  <div id="lb-tab">üèÜ Leaderboard</div>

  <!-- Leaderboard popup -->
  <div id="lb-popup">
      <div id="lb-popup-inner">
          <div id="lb-left" class="lb-arrow">‚Üê</div>
          <h2 id="lb-title">All-Time Earnings</h2>
          <div id="lb-content"></div>
          <div id="lb-right" class="lb-arrow">‚Üí</div>
          <button id="lb-close">Sluiten</button>
      </div>
  </div>

  <!-- MUSIC MENU -->
  <div id="musicMenu">
    <div id="musicMenuInner">
        <h3>Muziekinstellingen</h3>

        <label>Volume:</label><br>
        <input type="range" id="musicVolume" min="0" max="1" step="0.01">

        <br><br>

        <label>Muziek selecteren:</label>
        <select id="musicTrackSelect">
            <option value="0">Funky Upbeat</option>
            <option value="1">Electronic Chill</option>
            <option value="2">Lounge Vibes</option>
        </select>

        <br><br>

        <button id="muteBtn">Mute / Unmute</button>
        <br><br>

        <button id="closeMusicMenu">Sluiten</button>
    </div>
  </div>

  <script>
    // ====================
    // Data & helpers
    // ====================
    // users is keyed by lowercase username
    let users = JSON.parse(localStorage.getItem('users') || '{}');
    let currentUser = null; // will hold the user object (from users[key])
    function saveUsers(){ localStorage.setItem('users', JSON.stringify(users)); }

    // Helper to get lowercase key for a display name
    function keyForName(name){
      return name.trim().toLowerCase();
    }

    // ====================
    // UI refs
    // ====================
    const loginSection = document.getElementById('login');
    const dashboard = document.getElementById('dashboard');
    const blackjackSection = document.getElementById('blackjackSection');

    const usernameInput = document.getElementById('usernameInput');
    const passwordInput = document.getElementById('passwordInput');
    const loginBtn = document.getElementById('loginBtn');
    const displayName = document.getElementById('displayName');
    const creditsEl = document.getElementById('credits');
    const claimDailyBtn = document.getElementById('claimDailyBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const playBlackjackBtn = document.getElementById('playBlackjackBtn');
    const openLeaderboardsBtn = document.getElementById('openLeaderboardsBtn');

    const bgMusic = document.getElementById('bgMusic');
    const musicControl = document.getElementById('musicControl');
    const musicMenu = document.getElementById('musicMenu');
    const musicVolume = document.getElementById('musicVolume');
    const musicTrackSelect = document.getElementById('musicTrackSelect');
    const closeMusicMenu = document.getElementById('closeMusicMenu');
    const muteBtn = document.getElementById('muteBtn');

    // Blackjack refs
    const startGameBtn = document.getElementById('startGame');
    const botSelect = document.getElementById('botCount');
    const table = document.getElementById('table');
    const hitBtn = document.getElementById('hitBtn');
    const standBtn = document.getElementById('standBtn');
    const nextRoundBtn = document.getElementById('nextRoundBtn');

    // Leaderboard refs
    const lbTab = document.getElementById('lb-tab');
    const lbPopup = document.getElementById('lb-popup');
    const lbLeft = document.getElementById('lb-left');
    const lbRight = document.getElementById('lb-right');
    const lbClose = document.getElementById('lb-close');
    const lbTitle = document.getElementById('lb-title');
    const lbContent = document.getElementById('lb-content');

   const passwordInput = document.getElementById('passwordInput');
const createAccountBtn = document.getElementById('createAccountBtn');

function normalizeUsername(name) {
    return name.trim().toLowerCase(); // hoofdletters negeren
}

// LOGIN
loginBtn.onclick = ()=>{
    const name = normalizeUsername(usernameInput.value);
    const password = passwordInput.value;
    if(!name || !password) return alert('Vul gebruikersnaam en wachtwoord in.');

    if(!users[name]) return alert('Account bestaat niet.');
    if(users[name].password !== password) return alert('Wachtwoord verkeerd.');

    currentUser = users[name];
    localStorage.setItem('users', JSON.stringify(users));
    loginSection.style.display='none';
    dashboard.style.display='block';
    renderDashboard();
    bgMusic.play().catch(()=>{});
};

// CREATE ACCOUNT
createAccountBtn.onclick = ()=>{
    const name = normalizeUsername(usernameInput.value);
    const password = passwordInput.value;
    if(!name || !password) return alert('Vul gebruikersnaam en wachtwoord in.');

    if(users[name]) return alert('Account bestaat al.');

    users[name] = {
        name: usernameInput.value.trim(), // originele display
        password: password,
        credits: 500,
        lastDaily: null,
        wins: 0,
        losses: 0,
        totalEarned: 0,
        gamesPlayed: 0
    };

    currentUser = users[name];
    localStorage.setItem('users', JSON.stringify(users));
    loginSection.style.display='none';
    dashboard.style.display='block';
    renderDashboard();
    bgMusic.play().catch(()=>{});
};
      // try play music
      bgMusic.play().catch(()=>{});
    };

    function showDashboard(){
      loginSection.style.display = 'none';
      blackjackSection.style.display = 'none';
      dashboard.style.display = 'block';
      renderDashboard();
    }

    function renderDashboard(){
      if(!currentUser) return;
      displayName.textContent = currentUser.name;
      creditsEl.textContent = currentUser.credits;
    }

    logoutBtn.onclick = () => {
      currentUser = null;
      dashboard.style.display = 'none';
      loginSection.style.display = 'flex';
      bgMusic.pause();
    };

    claimDailyBtn.onclick = ()=> {
      if(!currentUser) return;
      const t = new Date().toDateString();
      if(currentUser.lastDaily !== t){
        currentUser.credits += 100;
        currentUser.lastDaily = t;
        users[currentUser.key] = currentUser;
        saveUsers();
        renderDashboard();
        alert('Dagelijkse bonus geclaimd: +100 credits');
      } else {
        alert('Je hebt vandaag al je bonus geclaimd.');
      }
    };

    // Leaderboards button in dashboard opens popup with earnings by default
    openLeaderboardsBtn.onclick = ()=> {
      lbIndex = 0;
      openLeaderboard();
    };

    // ====================
    // Music menu
    // ====================
    // default volume
    musicVolume.value = 0.4;
    bgMusic.volume = 0.4;

    musicControl.onclick = () => {
      musicMenu.style.display = musicMenu.style.display === 'block' ? 'none' : 'block';
      // populate current track selection if needed
    };

    musicVolume.oninput = () => {
      bgMusic.volume = parseFloat(musicVolume.value);
    };

    musicTrackSelect.onchange = () => {
      const index = parseInt(musicTrackSelect.value);
      // choose source element if present
      const sources = bgMusic.querySelectorAll('source');
      if(sources[index]) {
        bgMusic.src = sources[index].src;
        bgMusic.play().catch(()=>{});
      }
    };

    muteBtn.onclick = () => {
      bgMusic.muted = !bgMusic.muted;
      muteBtn.textContent = bgMusic.muted ? 'Unmute' : 'Mute / Unmute';
    };

    closeMusicMenu.onclick = ()=> { musicMenu.style.display = 'none'; };

    // ====================
    // Blackjack logic
    // ====================
    const suits=['‚ô†','‚ô•','‚ô¶','‚ô£'];
    const values=['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
    let deck=[];

    function createDeck(){
      deck = [];
      for(let s of suits) for(let v of values) deck.push({suit:s, value:v});
      // shuffle
      for(let i=deck.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [deck[i],deck[j]]=[deck[j],deck[i]]; }
    }
    function cardValue(card){ if(['J','Q','K'].includes(card.value)) return 10; if(card.value==='A') return 11; return parseInt(card.value); }
    function handValue(hand){ let total=0, aces=0; for(let c of hand){ total += cardValue(c); if(c.value==='A') aces++; } while(total>21 && aces>0){ total-=10; aces--; } return total; }
    function drawCard(){ return deck.pop(); }

    let players=[];
    let dealer={hand:[]};
    let currentPlayerIndex=0;

    // Positioning & rendering (uses same circle for dealer, player and bots)
    function placePlayers(){
      table.innerHTML = '';
      const centerX = table.clientWidth / 2;
      const centerY = table.clientHeight / 2;
      const kaartOffset = 60;
      const kaartWidth = 80;
      const kaartHeight = 120;
      const radius = Math.min(table.clientWidth, table.clientHeight) / 2 - kaartOffset;

      // angles: dealer at 0, player at pi, bots on pi/4 increments
      const dealerAngle = 0;
      const playerAngle = Math.PI;
      const botAngles = [Math.PI/4, 2*Math.PI/4, 3*Math.PI/4, 5*Math.PI/4, 6*Math.PI/4, 7*Math.PI/4];

      function pos(angle){
         return { x: centerX + radius * Math.cos(angle) - kaartWidth/2,
                  y: centerY + radius * Math.sin(angle) - kaartHeight/2 };
      }

      // dealer
      const dPos = pos(dealerAngle);
      const dealerDiv = document.createElement('div');
      dealerDiv.className = 'player-area';
      dealerDiv.style.left = dPos.x + 'px';
      dealerDiv.style.top = dPos.y + 'px';
      dealerDiv.innerHTML = `<h3>Dealer</h3><div class='cards'>${dealer.hand.map(c=>`<div class='card-bj'>${c.value}${c.suit}</div>`).join('')}</div>`;
      const dealerChair = document.createElement('div');
      dealerChair.className = 'chair';
      dealerChair.style.left = (dPos.x + kaartWidth/2) + 'px';
      dealerChair.style.top = (dPos.y + kaartHeight) + 'px';
      table.appendChild(dealerChair);
      table.appendChild(dealerDiv);

      // player (always players[0])
      if(players.length>0){
        const pPos = pos(playerAngle);
        const pDiv = document.createElement('div');
        pDiv.className = 'player-area';
        pDiv.style.left = pPos.x + 'px';
        pDiv.style.top = pPos.y + 'px';
        pDiv.innerHTML = `<h3>${players[0].name} ${currentPlayerIndex===0?'‚Üê':''}</h3><div class='cards'>${players[0].hand.map(c=>`<div class='card-bj'>${c.value}${c.suit}</div>`).join('')}</div><p>Score: ${handValue(players[0].hand)}</p>`;
        const pChair = document.createElement('div');
        pChair.className = 'chair';
        pChair.style.left = (pPos.x + kaartWidth/2) + 'px';
        pChair.style.top = (pPos.y + kaartHeight) + 'px';
        table.appendChild(pChair);
        table.appendChild(pDiv);
      }

      // bots
      const botCount = Math.max(0, players.length - 1);
      const botAnglesUsed = botAngles.slice(0, botCount);
      for(let i=1;i<players.length;i++){
        const posi = pos(botAnglesUsed[i-1]);
        const bDiv = document.createElement('div');
        bDiv.className = 'player-area';
        bDiv.style.left = posi.x + 'px';
        bDiv.style.top = posi.y + 'px';
        bDiv.innerHTML = `<h3>${players[i].name}</h3><div class='cards'>${players[i].hand.map(c=>`<div class='card-bj'>${c.value}${c.suit}</div>`).join('')}</div><p>Score: ${handValue(players[i].hand)}</p>`;
        const bChair = document.createElement('div');
        bChair.className = 'chair';
        bChair.style.left = (posi.x + kaartWidth/2) + 'px';
        bChair.style.top = (posi.y + kaartHeight) + 'px';
        table.appendChild(bChair);
        table.appendChild(bDiv);
      }
    }

    function renderGame(){ placePlayers(); }

    function nextPlayer(){
      currentPlayerIndex++;
      if(currentPlayerIndex >= players.length){
        dealerTurn();
      } else if(players[currentPlayerIndex].bot){
        botTurn(players[currentPlayerIndex]);
      }
      renderGame();
    }

    function botTurn(bot){
      let hv = handValue(bot.hand);
      while(hv < 16){
        bot.hand.push(drawCard());
        hv = handValue(bot.hand);
      }
      nextPlayer();
    }

    function dealerTurn(){
      let hv = handValue(dealer.hand);
      while(hv < 17){
        dealer.hand.push(drawCard());
        hv = handValue(dealer.hand);
      }
      checkWinners();
    }

    function checkWinners(){
      const dealerScore = handValue(dealer.hand);
      let resultMsg = `Dealer heeft ${dealerScore}.\n`;
      // iterate players and update results and credits & stats for real player
      for(let i=0;i<players.length;i++){
        const p = players[i];
        const ps = handValue(p.hand);
        let outcome = 'lose';
        if(ps > 21){
          resultMsg += `${p.name} verliest (bust).\n`;
          outcome = 'lose';
        } else if(dealerScore > 21 || ps > dealerScore){
          resultMsg += `${p.name} wint!\n`;
          outcome = 'win';
        } else if(ps === dealerScore){
          resultMsg += `${p.name} gelijkspel.\n`;
          outcome = 'push';
        } else {
          resultMsg += `${p.name} verliest.\n`;
          outcome = 'lose';
        }

        // update credits & stats for the human player only (players[0])
        if(i === 0 && currentUser){
          // define award: win +100, push 0, lose -100
          let delta = 0;
          if(outcome === 'win') delta = 100;
          else if(outcome === 'lose') delta = -100;
          else delta = 0;

          currentUser.credits += delta;
          // update user stats
          currentUser.gamesPlayed = (currentUser.gamesPlayed || 0) + 1;
          if(outcome === 'win'){ currentUser.wins = (currentUser.wins||0)+1; currentUser.totalEarned = (currentUser.totalEarned||0) + Math.max(0, delta); }
          else if(outcome === 'lose'){ currentUser.losses = (currentUser.losses||0)+1; currentUser.totalEarned = (currentUser.totalEarned||0) + Math.max(0, delta); }
          // push to users store
          users[currentUser.key] = currentUser;
          saveUsers();
          renderDashboard();
        }
      }

      alert(resultMsg);
      nextRoundBtn.style.display = 'inline';
      hitBtn.style.display = 'none';
      standBtn.style.display = 'none';

      // update global leaderboard storage (we use users object directly)
      // no extra call needed because we saved users above when player changed
    }

    function startRound(){
      createDeck();
      dealer.hand = [drawCard(), drawCard()];
      players.forEach(p => p.hand = [drawCard(), drawCard()]);
      currentPlayerIndex = 0;
      renderGame();
      // if first player is bot, let it play
      if(players[0] && players[0].bot) botTurn(players[0]);
      hitBtn.style.display = 'inline';
      standBtn.style.display = 'inline';
    }

    startGameBtn.onclick = () => {
      const botCount = parseInt(botSelect.value);
      // players[0] is the human player, set to currentUser's display name
      const humanName = currentUser ? currentUser.name : 'Jij';
      players = [{ name: humanName, bot: false, hand: [] }];
      for(let i=1;i<=botCount;i++){
        players.push({ name: `Bot ${i}`, bot: true, hand: [] });
      }
      startRound();
    };

    hitBtn.onclick = () => {
      const p = players[currentPlayerIndex];
      p.hand.push(drawCard());
      if(handValue(p.hand) > 21) { nextPlayer(); }
      renderGame();
    };

    standBtn.onclick = () => { nextPlayer(); };
    nextRoundBtn.onclick = () => { nextRoundBtn.style.display='none'; startRound(); };

    // ====================
    // Leaderboard popup logic
    // ====================
    let lbIndex = 0;
    const lbTypes = ['earnings','winrate'];

    function loadUsersArray(){
      // convert users map into array of objects for leaderboard sorting
      return Object.entries(users).map(([k,u]) => ({ key: k, name: u.name, totalEarned: u.totalEarned||0, wins: u.wins||0, losses: u.losses||0, games: u.gamesPlayed||0 }));
    }

    function openLeaderboard(){
      lbPopup.style.display = 'block';
      const type = lbTypes[lbIndex];
      lbTitle.textContent = type === 'earnings' ? 'All-Time Earnings' : 'Win Percentage';
      const arr = loadUsersArray();

      if(type === 'earnings'){
        arr.sort((a,b)=>b.totalEarned - a.totalEarned);
      } else {
        arr.sort((a,b)=>{
          const ra = a.games? (a.wins / a.games) : 0;
          const rb = b.games? (b.wins / b.games) : 0;
          return rb - ra;
        });
      }

      // Build HTML: top 10 and then own rank if outside
      let html = '';
      const top = arr.slice(0,10);
      top.forEach((u,i)=>{
        const isYou = currentUser && (u.key === currentUser.key);
        html += `<div style="padding:6px 0">${i+1}. <strong>${u.name}</strong> ${isYou?'<em>(jij)</em>':''} ${type==='earnings'?('‚Äî '+u.totalEarned+' credits'):('‚Äî '+(u.games?Math.round(100*u.wins/u.games):0)+'%') }</div>`;
      });

      // find own rank
      let yourRank = -1;
      if(currentUser){
        yourRank = arr.findIndex(x => x.key === currentUser.key);
      }
      if(yourRank > 9){
        const u = arr[yourRank];
        html += `<hr><div style="padding:6px 0">${yourRank+1}. <strong>${u.name}</strong> ${type==='earnings'?('‚Äî '+u.totalEarned+' credits'):('‚Äî '+(u.games?Math.round(100*u.wins/u.games):0)+'%')}</div>`;
      } else if(yourRank === -1 && currentUser){
        html += `<hr><div style="padding:6px 0">Jij staat nog niet in de statistieken.</div>`;
      }

      lbContent.innerHTML = html;
    }

    lbTab.onclick = ()=> { lbIndex = 0; openLeaderboard(); };
    lbClose.onclick = ()=> { lbPopup.style.display = 'none'; };
    lbLeft.onclick = ()=> { lbIndex = (lbIndex - 1 + lbTypes.length) % lbTypes.length; openLeaderboard(); };
    lbRight.onclick = ()=> { lbIndex = (lbIndex + 1) % lbTypes.length; openLeaderboard(); };

    // Ensure dashboard leaderboard button opens popup as well
    // openLeaderboardsBtn already wired earlier

    // ====================
    // Init view
    // ====================
    // Show login on load (unless you want auto-login)
    loginSection.style.display = 'flex';

    // Optional: if a user was last logged in and you want to auto-login, implement here.

  </script>
</body>
</html>
