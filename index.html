<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Goksite PWS ‚Äî Multiplayer Blackjack & Poker</title>
  <style>
    /* ============================ LEADERBOARD TAB STYLE ============================ */
    #lb-tab{
        position: fixed;
        right: 20px;
        bottom: 20px;
        background: gold;
        padding: 12px 20px;
        border-radius: 16px;
        cursor: pointer;
        font-weight: bold;
        box-shadow: 0 0 10px rgba(0,0,0,0.4);
        z-index: 9999;
    }

    /* ============================ POPUP WINDOW ============================ */
    #lb-popup{
        position: fixed;
        bottom: 0;
        right: 0;
        width: 360px;
        height: 460px;
        background: rgba(0,0,0,0.88);
        border-radius: 20px 0 0 0;
        display: none;
        z-index: 99999;
        color: white;
    }

    #lb-popup-inner{
        padding: 18px;
        height: 100%;
        position: relative;
    }

    /* ============================ ARROWS ============================ */
    .lb-arrow{
        position: absolute;
        top: 12px;
        font-size: 26px;
        cursor: pointer;
        user-select: none;
    }
    #lb-left{ left: 10px; }
    #lb-right{ right: 10px; }

    /* ============================ CONTENT AREA ============================ */
    #lb-content{
        margin-top: 52px;
        height: 330px;
        overflow-y: auto;
        font-size: 16px;
    }

    #lb-close{
        position: absolute;
        bottom: 14px;
        left: 50%;
        transform: translateX(-50%);
        padding: 8px 20px;
        border-radius: 10px;
        cursor: pointer;
    }

    /* ============================ Music menu style ============================ */
    #musicMenu{
      position: fixed;
      right: 20px;
      bottom: 70px;
      width: 300px;
      background: rgba(0,0,0,0.92);
      color: white;
      padding: 15px;
      border-radius: 12px;
      display: none;
      z-index: 99999;
    }

    #musicMenuInner{
      text-align: center;
    }

    #musicMenu input[type=range]{
      width: 80%;
    }

    /* ============================ Rest of page ============================ */
    body { margin:0; font-family: system-ui, sans-serif; background:#050515; color:#fff;}
    #login, #dashboard, #blackjackSection, #pokerSection { display: none; padding: 20px; text-align:center; }
    #login { background: radial-gradient(circle at top, #551a8b 0, #050515 55%, #020208 100%); height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center; gap:8px; }
    #dashboard { background: radial-gradient(circle at top, #4c1d7f 0, #050515 55%, #020208 100%); min-height:100vh; }
    #dashboard h2, #login h2 { margin-bottom:10px; }
    button { padding: 10px 14px; margin: 6px; border-radius: 8px; border:none; cursor:pointer; background:#e21a4d; color:#fff; font-weight:600; }
    button:hover{ filter:brightness(1.05); }
    input { padding:8px 10px; border-radius:6px; border:1px solid #444; background:#111; color:#fff; }

    /* Blackjack sectie */
    #blackjackSection {
      height: 100vh;
      color: white;
      background:
        radial-gradient(circle at 20% 0%, rgba(255,255,255,0.08), transparent 55%),
        radial-gradient(circle at 80% 100%, rgba(255,255,255,0.04), transparent 55%),
        radial-gradient(circle at center, #1c7b52 0, #094432 55%, #031614 100%);
    }

    .table-container {
      position: relative;
      width: 90%;
      max-width: 900px;
      margin: 36px auto;
      height: 520px;
      perspective: 900px;
    }

    .table {
      position: relative;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background:
        radial-gradient(circle at 30% 20%, #2fbf7a 0, #12724b 45%, #063024 100%);
      box-shadow:
        0 18px 40px rgba(0,0,0,0.8),
        inset 0 0 25px rgba(0,0,0,0.85);
      border: 8px solid #c59b45;
      transform: rotateX(18deg);
      transform-origin: center 120%;
    }

    .table::before{
      content:'';
      position:absolute;
      inset:18%;
      border-radius:50%;
      border:2px solid rgba(255,255,255,0.15);
      box-shadow:0 0 12px rgba(0,0,0,0.7);
      pointer-events:none;
    }

    .player-area { position:absolute; text-align:center; color: white; transition: transform 0.2s ease, box-shadow 0.2s ease; }

    .player-area.active-player {
      transform: translateY(-6px) scale(1.05);
      box-shadow: 0 0 18px rgba(255, 215, 0, 0.65);
    }

    .cards { display:flex; justify-content:center; gap:8px; margin-top:8px; }

    .card-bj {
      width:80px;
      height:120px;
      border-radius:10px;
      background:linear-gradient(145deg,#fdfdfd,#f3f3f3);
      color:#111;
      border:2px solid #d4af37;
      display:flex;
      justify-content:center;
      align-items:center;
      font-weight:700;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      font-size:20px;
      box-shadow:
        0 6px 14px rgba(0,0,0,0.7),
        inset 0 0 0 1px rgba(255,255,255,0.8);
      position:relative;
      overflow:hidden;
      transition: transform 0.18s ease, box-shadow 0.18s ease;
    }

    .card-bj.card-back {
      background: radial-gradient(circle at 30% 20%, #fff8d0 0, #d4af37 35%, #8b6b1f 100%);
      box-shadow:
        0 6px 18px rgba(0,0,0,0.8),
        inset 0 0 0 1px rgba(255,255,255,0.9);
    }

    .chair {
      width:50px;
      height:50px;
      background:radial-gradient(circle at 30% 20%, #555, #222);
      border-radius:50%;
      position:absolute;
      box-shadow:
        0 4px 10px rgba(0,0,0,0.6),
        inset 0 -4px 8px rgba(0,0,0,0.8);
      border:2px solid #666;
    }

    #controls { margin-top:20px; }

    /* Poker section */
    #pokerSection { background:#0f2b2a; min-height:100vh; color:white; padding-bottom:40px; }
    .poker-table { width:90%; max-width:1000px; margin:20px auto; background:linear-gradient(145deg,#123835,#041817); border-radius:16px; padding:18px; box-shadow:0 8px 30px rgba(0,0,0,0.5); }
    .community { display:flex; justify-content:center; gap:8px; margin:12px 0; }
    .card-pk { width:72px; height:102px; background:white; color:black; border-radius:8px; display:flex; justify-content:center; align-items:center; font-weight:bold; box-shadow:0 6px 16px rgba(0,0,0,0.7); }
    .poker-players { display:flex; flex-wrap:wrap; justify-content:center; gap:12px; margin-top:16px; }
    .poker-player { min-width:140px; padding:10px; border-radius:10px; background:rgba(0,0,0,0.4); border:1px solid rgba(255,255,255,0.06); }
    .poker-player h4{ margin:0 0 6px 0; font-size:14px; }
    .poker-player .hand{ display:flex; justify-content:center; gap:6px; margin:6px 0; }
    .poker-info-row{ margin-top:8px; font-size:13px; }
    .poker-pot-row{ margin-top:8px; font-weight:bold; }
    .poker-seat-row{ font-size:12px; color:#ccc; }
    small { font-size:12px; color:#ddd; }

    .poker-controls { margin-top:14px; }

    /* Global credits display */
    #creditsDisplayGlobal{
      position: fixed;
      top: 12px;
      left: 12px;
      background: rgba(0,0,0,0.6);
      color: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 16px;
      z-index: 99999;
      display: none;
    }

    /* small responsive */
    @media (max-width:600px){
      #lb-popup { width: 100%; right:0; left:0; height: 50vh; border-radius: 12px 12px 0 0;}
      .card-bj{ width:56px; height:84px; }
      .table-container{ height:360px; }
      .card-pk{ width:56px; height:84px; }
    }
  </style>
</head>
<body>

  <!-- Globale credits overlay -->
  <div id="creditsDisplayGlobal">
    Credits: <span id="globalCredits">0</span>
  </div>

  <!-- Login / Account aanmaken -->
  <section id="login">
    <h2>Welkom! Maak een account of log in</h2>
    <input type="text" id="usernameInput" placeholder="Gebruikersnaam">
    <input type="password" id="passwordInput" placeholder="Wachtwoord">
    <button id="loginBtn">Login</button>
    <button id="createAccountBtn">Account aanmaken</button>
  </section>

  <!-- Dashboard -->
  <section id="dashboard">
    <h2>Welkom, <span id="displayName"></span></h2>
    <p>Credits: <span id="credits"></span></p>
    <button id="claimDailyBtn">Claim dagelijkse bonus</button><br>
    <button id="playBlackjackBtn">Speel Blackjack</button>
    <button id="playPokerBtn">Speel Poker</button>
    <button id="logoutBtn">Uitloggen</button>

    <!-- Music control -->
    <div style="margin-top:12px;">
      <audio id="bgMusic" loop>
        <source src="https://cdn.pixabay.com/audio/2023/03/07/audio_2ea36d1deb.mp3" type="audio/mpeg">
        <source src="https://cdn.pixabay.com/audio/2023/03/15/audio_e3bbcbfce7.mp3" type="audio/mpeg">
        <source src="https://cdn.pixabay.com/audio/2022/03/15/audio_8f17fc4b42.mp3" type="audio/mpeg">
      </audio>
      <button id="musicControl">üéµ Muziek</button>
    </div>
  </section>

  <!-- Blackjack -->
  <section id="blackjackSection">
    <h2>Blackjack</h2>
    <div>
      <label>Kies aantal bots:</label>
      <select id="botCount">
        <option value="0">0 bots</option>
        <option value="1">1 bot</option>
        <option value="2">2 bots</option>
        <option value="3">3 bots</option>
        <option value="4">4 bots</option>
        <option value="5">5 bots</option>
        <option value="6">6 bots</option>
        </select><br><br>
      <label>Inzet (credits):</label>
      <input type="number" id="betAmount" min="1" value="100">
      <button id="startGame">Start spel</button>
      <button id="backToMenu">Terug naar menu</button>
    </div>
    <div class="table-container">
      <div class="table" id="table">
        <!-- Stoelen + spelergebieden komen hier dynamisch -->
      </div>
    </div>
    <div id="controls">
      <button id="hitBtn">Hit</button>
      <button id="standBtn">Stand</button>
      <button id="nextRoundBtn" style="display:none">Volgende ronde</button>
    </div>
  </section>

  <!-- Poker -->
  <section id="pokerSection">
    <h2>Texas Hold'em Poker</h2>
    <p>Speel tegen bots met echte potten & side pots (voor je PWS natuurlijk üòâ).</p>

    <div style="margin:10px 0;">
      <label>Minimale credits om mee te doen: 500. Kies tafel:</label><br>
      <select id="pokerTableSelect">
        <option value="500">Tafel 500</option>
        <option value="1500">Tafel 1500</option>
        <option value="3500">Tafel 3500</option>
        <option value="5000">Tafel 5000</option>
      </select>
      <button id="joinPokerBtn">Deelnemen</button>
      <button id="leavePokerBtn">Tafel verlaten</button>
      <button id="backFromPokerBtn">Terug naar menu</button>
    </div>

    <div class="poker-table">
      <div class="poker-pot-row">
        Pot: <span id="pokerPot">0</span> | Side pot: <span id="pokerSidePot">0</span>
      </div>
      <div class="community" id="pokerCommunity"></div>
      <div class="poker-players" id="pokerPlayers"></div>

      <div class="poker-controls">
        <p><strong>Jouw actie:</strong></p>
        <button id="pokerCheckBtn">Check / Call</button>
        <button id="pokerBetBtn">Bet / Raise</button>
        <button id="pokerFoldBtn">Fold</button>
        <div style="margin-top:6px;">
          <label>Bet bedrag:</label>
          <input type="number" id="pokerBetAmount" min="0" value="100" style="width:100px;">
        </div>
        <small id="pokerStatus"></small>
      </div>
    </div>
  </section>

  <!-- Leaderboard floating tab -->
  <div id="lb-tab">üèÜ Leaderboard</div>

  <!-- Leaderboard popup -->
  <div id="lb-popup">
      <div id="lb-popup-inner">
          <div id="lb-left" class="lb-arrow">‚Üê</div>
          <h2 id="lb-title">All-Time Earnings</h2>
          <div id="lb-content"></div>
          <div id="lb-right" class="lb-arrow">‚Üí</div>
          <button id="lb-close">Sluiten</button>
      </div>
  </div>

  <!-- MUSIC MENU -->
  <div id="musicMenu">
    <div id="musicMenuInner">
        <h3>Muziekinstellingen</h3>
        <label>Volume:</label><br>
        <input type="range" id="musicVolume" min="0" max="1" step="0.01">
        <br><br>
        <label>Muziek selecteren:</label>
        <select id="musicTrackSelect">
            <option value="0">Funky Upbeat</option>
            <option value="1">Electronic Chill</option>
            <option value="2">Lounge Vibes</option>
        </select>
        <br><br>
        <button id="muteBtn">üéµ Mute</button>
        <br><br>
        <button id="closeMusicMenu">Sluiten</button>
    </div>
  </div>

  <!-- Firebase v8 (online accounts & leaderboards) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyARtIFfUXzlkJppkcUSx5ril2FerJltwNs",
      authDomain: "gokken4school.firebaseapp.com",
      databaseURL: "https://gokken4school-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "gokken4school",
      storageBucket: "gokken4school.firebasestorage.app",
      messagingSenderId: "210902717668",
      appId: "1:210902717668:web:16ebea58067718ffce48f1",
      measurementId: "G-G9SVYLDMWC"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
  </script>

  <script>
    /* ---------------------------
       Data & helpers
       --------------------------- */
    let users = {};
    let currentUser = null;

    function keyForName(name){ return name.trim().toLowerCase(); }

    async function loadUser(key){
      const snap = await db.ref('users/'+key).once('value');
      return snap.val() || null;
    }
    async function saveCurrentUser(){
      if(!currentUser || !currentUser.key) return;
      await db.ref('users/'+currentUser.key).set(currentUser);
    }

    /* ---------------------------
       UI refs
       --------------------------- */
    const loginSection = document.getElementById('login');
    const dashboard = document.getElementById('dashboard');
    const blackjackSection = document.getElementById('blackjackSection');
    const pokerSection = document.getElementById('pokerSection');
    const backFromPokerBtn = document.getElementById('backFromPokerBtn');

    const usernameInput = document.getElementById('usernameInput');
    const passwordInput = document.getElementById('passwordInput');
    const loginBtn = document.getElementById('loginBtn');
    const createAccountBtn = document.getElementById('createAccountBtn');
    const displayName = document.getElementById('displayName');
    const creditsEl = document.getElementById('credits');
    const claimDailyBtn = document.getElementById('claimDailyBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const playBlackjackBtn = document.getElementById('playBlackjackBtn');
    const playPokerBtn = document.getElementById('playPokerBtn');
    const openLeaderboardsBtn = document.getElementById('openLeaderboardsBtn');

    const bgMusic = document.getElementById('bgMusic');
    const musicControl = document.getElementById('musicControl');
    const musicMenu = document.getElementById('musicMenu');
    const musicVolume = document.getElementById('musicVolume');
    const musicTrackSelect = document.getElementById('musicTrackSelect');
    const closeMusicMenu = document.getElementById('closeMusicMenu');
    const muteBtn = document.getElementById('muteBtn');

    /* Blackjack refs */
    const startGameBtn = document.getElementById('startGame');
    const botSelect = document.getElementById('botCount');
    const betAmountInput = document.getElementById('betAmount');
    const table = document.getElementById('table');
    const hitBtn = document.getElementById('hitBtn');
    const standBtn = document.getElementById('standBtn');
    const nextRoundBtn = document.getElementById('nextRoundBtn');
    const backToMenuBtn = document.getElementById('backToMenu');

    /* Poker refs */
    const pokerTableSelect = document.getElementById('pokerTableSelect');
    const joinPokerBtn = document.getElementById('joinPokerBtn');
    const leavePokerBtn = document.getElementById('leavePokerBtn');
    const pokerPotEl = document.getElementById('pokerPot');
    const pokerSidePotEl = document.getElementById('pokerSidePot');
    const pokerCommunityEl = document.getElementById('pokerCommunity');
    const pokerPlayersEl = document.getElementById('pokerPlayers');
    const pokerCheckBtn = document.getElementById('pokerCheckBtn');
    const pokerBetBtn = document.getElementById('pokerBetBtn');
    const pokerFoldBtn = document.getElementById('pokerFoldBtn');
    const pokerBetAmountInput = document.getElementById('pokerBetAmount');
    const pokerStatusEl = document.getElementById('pokerStatus');

    /* Leaderboard refs */
    const lbTab = document.getElementById('lb-tab');
    const lbPopup = document.getElementById('lb-popup');
    const lbLeft = document.getElementById('lb-left');
    const lbRight = document.getElementById('lb-right');
    const lbClose = document.getElementById('lb-close');
    const lbTitle = document.getElementById('lb-title');
    const lbContent = document.getElementById('lb-content');

    const creditsGlobalSpan = document.getElementById('globalCredits');

    /* ---------------------------
       Login / accounts
       --------------------------- */
    loginSection.style.display = 'flex';

    loginBtn.onclick = async ()=>{
      const rawName = usernameInput.value.trim();
      const passwd = passwordInput.value.trim();
      if(!rawName || !passwd) return alert('Vul gebruikersnaam en wachtwoord in.');

      const key = keyForName(rawName);
      const existing = await loadUser(key);
      if(!existing) return alert('Account bestaat niet.');
      if(existing.password !== passwd) return alert('Wachtwoord onjuist.');

      currentUser = existing;
      currentUser.key = key;
      loginSection.style.display='none';
      dashboard.style.display='block';
      renderDashboard();
      bgMusic.play().catch(()=>{});
    };

    createAccountBtn.onclick = async ()=>{
      const rawName = usernameInput.value.trim();
      const passwd = passwordInput.value.trim();
      if(!rawName || !passwd) return alert('Vul gebruikersnaam en wachtwoord in.');

      const key = keyForName(rawName);
      const existing = await loadUser(key);
      if(existing){
        alert('Account bestaat al.');
        return;
      }

      currentUser = {
        key,
        name: rawName,
        password: passwd,
        credits: 1000,
        lastDaily: null,
        wins: 0,
        losses: 0,
        gamesPlayed: 0,
        totalEarned: 0,
        bjWins: 0,
        bjLosses: 0,
        bjGames: 0,
        pkWins: 0,
        pkLosses: 0,
        pkGames: 0
      };
      await saveCurrentUser();
      loginSection.style.display='none';
      dashboard.style.display='block';
      renderDashboard();
      bgMusic.play().catch(()=>{});
    };

    function renderDashboard(){
      if(!currentUser) return;
      displayName.textContent = currentUser.name;
      creditsEl.textContent = currentUser.credits;
      const bar = document.getElementById('creditsDisplayGlobal');
      if(bar){
        bar.style.display = 'block';
        creditsGlobalSpan.textContent = currentUser.credits;
      }
    }

    logoutBtn.onclick = () => {
      currentUser = null;
      dashboard.style.display = 'none';
      blackjackSection.style.display = 'none';
      pokerSection.style.display = 'none';
      loginSection.style.display = 'flex';
      bgMusic.pause();
      const bar = document.getElementById('creditsDisplayGlobal');
      if(bar) bar.style.display = 'none';
    };

    claimDailyBtn.onclick = async ()=>{
      if(!currentUser) return;
      const t = new Date().toDateString();
      if(currentUser.lastDaily !== t){
        currentUser.credits += 100;
        currentUser.lastDaily = t;
        await saveCurrentUser();
        renderDashboard();
        alert('Dagelijkse bonus geclaimd: +100 credits');
      } else {
        alert('Je hebt vandaag al je bonus geclaimd.');
      }
    };

    playBlackjackBtn.onclick = ()=>{
      dashboard.style.display='none';
      pokerSection.style.display='none';
      blackjackSection.style.display='block';
    };

    playPokerBtn.onclick = ()=>{
      dashboard.style.display='none';
      blackjackSection.style.display='none';
      pokerSection.style.display='block';
    };

    backToMenuBtn.onclick = ()=>{
      blackjackSection.style.display='none';
      pokerSection.style.display='none';
      dashboard.style.display='block';
    };

    /* ---------------------------
       Music menu
       --------------------------- */
    musicVolume.value = 0.4;
    bgMusic.volume = 0.4;

    musicControl.onclick = () => { musicMenu.style.display = (musicMenu.style.display==='block'?'none':'block'); };
    musicVolume.oninput = ()=>{ bgMusic.volume = parseFloat(musicVolume.value); };
    musicTrackSelect.onchange = ()=>{
      const index = parseInt(musicTrackSelect.value);
      const sources = bgMusic.querySelectorAll('source');
      if(sources[index]){
        bgMusic.pause();
        bgMusic.src = sources[index].src;
        bgMusic.load();
        bgMusic.play().catch(()=>{});
      }
    };
    muteBtn.onclick = ()=>{ bgMusic.muted = !bgMusic.muted; muteBtn.textContent = bgMusic.muted ? 'üîá Unmute' : 'üéµ Mute'; };
    closeMusicMenu.onclick = ()=>{ musicMenu.style.display='none'; };

    /* ---------------------------
       Blackjack logic
       --------------------------- */
    const suits=['‚ô†','‚ô•','‚ô¶','‚ô£'];
    const values=['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
    let deck=[];

    function createDeck(){
      deck=[];
      for(let s of suits) for(let v of values) deck.push({suit:s, value:v});
      for(let i=deck.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [deck[i],deck[j]]=[deck[j],deck[i]]; }
    }
    function cardValue(card){ if(['J','Q','K'].includes(card.value)) return 10; if(card.value==='A') return 11; return parseInt(card.value); }
    function handValue(hand){ let total=0, aces=0; for(let c of hand){ total+=cardValue(c); if(c.value==='A') aces++; } while(total>21 && aces>0){ total-=10; aces--; } return total; }
    function drawCard(){ return deck.pop(); }

    let players=[]; // includes human and bots
    let dealer={hand:[], name:'Dealer'};
    let currentPlayerIndex=0;
    let currentBet = 100;

    
    function placePlayers() {
      table.innerHTML = '';

      const centerX = table.clientWidth / 2;
      const centerY = table.clientHeight / 2;
      const cardW = 80;
      const cardH = 120;

      // binnenradius: dealer & speler, iets binnen de rand
      const innerRadius = Math.min(centerX, centerY) - 120;

      // buitenradius: bots, precies op de rand van de tafel
      const outerRadius = Math.min(centerX, centerY) - 70;

      // hoeken: dealer boven (12 uur), speler onder (6 uur)
      const dealerAngle = -Math.PI / 2;
      const playerAngle =  Math.PI / 2;

      const botCount = Math.max(0, players.length - 1);

      function getPos(radius, angle) {
        return {
          x: centerX + radius * Math.cos(angle) - cardW / 2,
          y: centerY + radius * Math.sin(angle) - cardH / 2
        };
      }

      function createPlayerArea(label, hand, angle, radius, isActive) {
        const pos = getPos(radius, angle);

        const div = document.createElement('div');
        div.className = 'player-area';
        if (isActive) div.classList.add('active-player');
        div.style.left = pos.x + 'px';
        div.style.top = pos.y + 'px';

        const cardsHTML = hand.map(c =>
          `<div class="card-bj">${c.value}${c.suit}</div>`
        ).join('');

        div.innerHTML = `
          <h3>${label}</h3>
          <div class="cards">${cardsHTML}</div>
          <p>Score: ${handValue(hand)}</p>
        `;

        table.appendChild(div);
      }

      // Dealer (nooit actief)
      // Dealer met hole card: eerste kaart face-down als dealerReveal nog false is
      (function(){
        const radius = innerRadius;
        const angle = dealerAngle;
        const pos = {
          x: centerX + radius * Math.cos(angle) - cardW / 2,
          y: centerY + radius * Math.sin(angle) - cardH / 2
        };
        const div = document.createElement('div');
        div.className = 'player-area';
        div.style.left = pos.x + 'px';
        div.style.top = pos.y + 'px';

        let cardsHTML = '';
        if (!dealerReveal && dealer.hand.length > 0) {
          // eerste kaart rug, tweede kaart open
          cardsHTML += `<div class="card-bj card-back"></div>`;
          for (let i = 1; i < dealer.hand.length; i++) {
            const c = dealer.hand[i];
            cardsHTML += `<div class="card-bj">${c.value}${c.suit}</div>`;
          }
        } else {
          cardsHTML = dealer.hand.map(c => `<div class="card-bj">${c.value}${c.suit}</div>`).join('');
        }

        const scoreText = dealerReveal ? handValue(dealer.hand) : '?';

        div.innerHTML = `
          <h3>Dealer</h3>
          <div class="cards">${cardsHTML}</div>
          <p>Score: ${scoreText}</p>
        `;
        table.appendChild(div);
      })();

      // Speler (altijd players[0])
      if (players.length > 0) {
        const isActivePlayer = currentPlayerIndex === 0;
        createPlayerArea(players[0].name, players[0].hand, playerAngle, innerRadius, isActivePlayer);
      }

      // Bots langs de rand, gelijk verdeeld over 360¬∞
      if (botCount > 0) {
        for (let i = 1; i < players.length; i++) {
          const botIndex = i - 1;                // 0..botCount-1
          const angle = (2 * Math.PI * botIndex / botCount) - Math.PI / 2; // rondom, start boven
          const isActiveBot = currentPlayerIndex === i;
          createPlayerArea(players[i].name, players[i].hand, angle, outerRadius, isActiveBot);
        }
      }
    }


      function renderGame(){ placePlayers(); }

ntPlayerIndex++;
      if(currentPlayerIndex >= players.length){
        dealerTurn();
      } else if(players[currentPlayerIndex].bot){
        botTurn(players[currentPlayerIndex]);
      }
      renderGame();

    function botTurn(bot){
      let hv = handValue(bot.hand);
      while(hv<16){
        bot.hand.push(drawCard());
        hv=handValue(bot.hand);
      }
      nextPlayer();
    }

    function dealerTurn(){
      dealerReveal = true;
      renderGame();
      let hv = handValue(dealer.hand);
      while(hv<17){
        dealer.hand.push(drawCard());
        hv=handValue(dealer.hand);
      }
      renderGame();
      checkWinners();
    }

    function checkWinners(){
      const dealerScore=handValue(dealer.hand);
      let resultMsg=`Dealer heeft ${dealerScore}.\n`;

      for(let i=0;i<players.length;i++){
        const p=players[i];
        const ps=handValue(p.hand);
        let outcome='lose';
        if(ps>21){
          resultMsg+=`${p.name} verliest (bust).\n`;
          outcome='lose';
        } else if(dealerScore>21 || ps>dealerScore){
          resultMsg+=`${p.name} wint!\n`;
          outcome='win';
        } else if(ps===dealerScore){
          resultMsg+=`${p.name} gelijkspel.\n`;
          outcome='push';
        } else{
          resultMsg+=`${p.name} verliest.\n`;
          outcome='lose';
        }

        if(i===0 && currentUser){
          let delta = 0;
          if(outcome==='win') delta = Math.floor(currentBet*1.5);
          else if(outcome==='push') delta = Math.floor(currentBet*1.0);
          else delta = 0;
          currentUser.credits += delta;
          currentUser.gamesPlayed = (currentUser.gamesPlayed||0)+1;
          if(outcome==='win'){ currentUser.wins=(currentUser.wins||0)+1; currentUser.totalEarned=(currentUser.totalEarned||0)+delta; currentUser.bjWins=(currentUser.bjWins||0)+1; }
          else if(outcome==='lose'){ currentUser.losses=(currentUser.losses||0)+1; currentUser.bjLosses=(currentUser.bjLosses||0)+1; }
          currentUser.bjGames=(currentUser.bjGames||0)+1;
        }
      }

      alert(resultMsg);
      nextRoundBtn.style.display='inline';
      hitBtn.style.display='none';
      standBtn.style.display='none';

      if(currentUser){
        saveCurrentUser().then(renderDashboard);
      }
    }

    function startRound(){
      if(!currentUser) return;
      const requestedBet = parseInt(betAmountInput.value)||100;
      if(currentUser.credits < requestedBet){
        alert('Je hebt niet genoeg credits voor deze inzet.');
        return;
      }
      currentBet = requestedBet;
      currentUser.credits -= currentBet;
      saveCurrentUser().then(renderDashboard);

      createDeck();
      dealer.hand=[drawCard(), drawCard()];
      players.forEach(p=>p.hand=[drawCard(), drawCard()]);
      currentPlayerIndex=0;
      renderGame();
      if(players[0].bot) botTurn(players[0]);
      hitBtn.style.display='inline';
      standBtn.style.display='inline';
      nextRoundBtn.style.display='none';
    }

    startGameBtn.onclick = ()=>{
      if(!currentUser) return alert('Je moet eerst inloggen!');
      const botCount=parseInt(botSelect.value);
      players=[{ name:currentUser.name, bot:false, hand:[] }];
      for(let i=1;i<=botCount;i++) players.push({ name:`Bot ${i}`, bot:true, hand:[] });
      dealer.hand=[];
      startRound();
    };

    hitBtn.onclick = ()=>{
      const p = players[currentPlayerIndex];
      p.hand.push(drawCard());
      if(handValue(p.hand)>21) nextPlayer();
      renderGame();
    };

    standBtn.onclick = ()=>{ nextPlayer(); };
    nextRoundBtn.onclick = ()=>{ nextRoundBtn.style.display='none'; startRound(); };

    /* ---------------------------
       Poker logic (bestaande logica, niet gewijzigd aan structuur)
       --------------------------- */

    const pkSuits = ['‚ô†','‚ô•','‚ô¶','‚ô£'];
    const pkValues = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
    let pkDeck = [];

    function pkCreateDeck(){
      pkDeck=[];
      for(let s of pkSuits) for(let v of pkValues) pkDeck.push({suit:s,value:v});
      for(let i=pkDeck.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [pkDeck[i],pkDeck[j]]=[pkDeck[j],pkDeck[i]]; }
    }

    let pokerPlayers = [];
    let pokerPot = 0;
    let pokerSidePot = 0;
    let pokerCommunity = [];
    let pokerCurrentPlayerIndex = 0;
    let pokerTableMin = 500;

    function pkDraw(){ return pkDeck.pop(); }

    function pkRender(){
      pokerPotEl.textContent = pokerPot;
      pokerSidePotEl.textContent = pokerSidePot;
      pokerCommunityEl.innerHTML = pokerCommunity.map(c=>`<div class="card-pk">${c.value}${c.suit}</div>`).join('');
      pokerPlayersEl.innerHTML = pokerPlayers.map((p,i)=>{
        const isYou = currentUser && p.key===currentUser.key;
        return `<div class="poker-player">
          <h4>${p.name} ${isYou?'(jij)':''} ${i===pokerCurrentPlayerIndex?'‚Üê':''}</h4>
          <div class="hand">${p.hand.map(c=>`<div class="card-pk">${c.value}${c.suit}</div>`).join('')}</div>
          <div class="poker-info-row">Stack: ${p.stack}</div>
          <div class="poker-info-row">Ingezet: ${p.bet} (committed: ${p.committed})</div>
          <div class="poker-seat-row">Seat ${p.seat} ${p.folded?'[FOLDED]':''} ${p.allIn?'[ALL-IN]':''}</div>
        </div>`;
      }).join('');
    }

    function pkNewHand(){
      pkCreateDeck();
      pokerPot = 0;
      pokerSidePot = 0;
      pokerCommunity = [];
      pokerPlayers.forEach(p=>{
        p.hand = [pkDraw(), pkDraw()];
        p.bet = 0;
        p.committed = 0;
        p.folded = false;
        p.allIn = false;
      });
      pokerCurrentPlayerIndex = 0;
      pkRender();
      pokerStatusEl.textContent = 'Nieuwe hand gestart.';
    }

    function PK_addBotsIfNeeded(){
      const desiredSeats = 6;
      const occupiedSeats = new Set(pokerPlayers.map(p=>p.seat));
      let nextSeat = 1;
      while(occupiedSeats.size < desiredSeats){
        while(occupiedSeats.has(nextSeat)) nextSeat++;
        const seatIdx = nextSeat;
        occupiedSeats.add(seatIdx);
        const nextIdx = pokerPlayers.filter(p=>p.isBot).length + 1;
        const player = {
          key: 'bot'+nextIdx,
          name: 'Bot '+nextIdx,
          stack: 2000,
          entryStack: 2000,
          hand: [],
          bet: 0,
          committed: 0,
          folded: false,
          allIn: false,
          isBot: true,
          seat: seatIdx
        };
        pokerPlayers.push(player);
      }
    }

    joinPokerBtn.onclick = ()=>{
      if(!currentUser) return alert('Je moet inloggen.');
      const min = parseInt(pokerTableSelect.value)||500;
      if(currentUser.credits < min){
        alert('Je hebt niet genoeg credits voor deze tafel.');
        return;
      }
      pokerTableMin = min;

      if(pokerPlayers.some(p=>p.key===currentUser.key)){
        alert('Je zit al aan de tafel.');
        return;
      }

      currentUser.credits -= pokerTableMin;
      currentUser.entryStack = pokerTableMin;
      const seat = pokerPlayers.length ? Math.max(...pokerPlayers.map(p=>p.seat))+1 : 1;
      pokerPlayers.push({
        key: currentUser.key,
        name: currentUser.name,
        stack: pokerTableMin,
        entryStack: pokerTableMin,
        hand:[],
        bet:0,
        committed:0,
        folded:false,
        allIn:false,
        isBot:false,
        seat
      });

      PK_addBotsIfNeeded();
      saveCurrentUser().then(renderDashboard);
      pkNewHand();
      pokerSection.style.display='block';
      dashboard.style.display='none';
    };

    leavePokerBtn.onclick = ()=>{
      if(!currentUser) return;
      const idx = pokerPlayers.findIndex(p=>p.key===currentUser.key);
      if(idx===-1){
        alert('Je zit niet aan de tafel.');
        return;
      }
      const pl = pokerPlayers[idx];
      currentUser.credits += pl.stack;
      pokerPlayers.splice(idx,1);
      saveCurrentUser().then(()=>{
        renderDashboard();
        alert('Tafel verlaten. Je hebt nu weer '+currentUser.credits+' credits.');
      });
    };

    backFromPokerBtn.onclick = ()=>{
      // Alleen navigatie: terug naar dashboard
      pokerSection.style.display = 'none';
      blackjackSection.style.display = 'none';
      dashboard.style.display = 'block';
    };

    pokerCheckBtn.onclick = ()=>{
      pokerStatusEl.textContent = 'Check / Call uitgevoerd (demo).';
    };
    pokerBetBtn.onclick = ()=>{
      pokerStatusEl.textContent = 'Bet / Raise uitgevoerd (demo).';
    };
    pokerFoldBtn.onclick = ()=>{
      pokerStatusEl.textContent = 'Fold (demo).';
    };

    /* ---------------------------
       Leaderboard popup
       --------------------------- */
    let lbIndex = 0;
    const lbTypes = ['earnings','winrate','bjwinrate','pkwinrate'];

    async function loadUsersArrayFromDb(){
      const snap = await db.ref('users').once('value');
      const obj = snap.val() || {};
      return Object.entries(obj).map(([k,u])=>({
        key: k,
        name: u.name,
        totalEarned: u.totalEarned||0,
        wins: u.wins||0,
        losses: u.losses||0,
        games: u.gamesPlayed||0,
        bjWins: u.bjWins||0,
        bjLosses: u.bjLosses||0,
        bjGames: u.bjGames||0,
        pkWins: u.pkWins||0,
        pkLosses: u.pkLosses||0,
        pkGames: u.pkGames||0
      }));
    }

    async function openLeaderboard(){
      lbPopup.style.display='block';
      const type = lbTypes[lbIndex];
      let title = '';
      if(type==='earnings') title = 'All-Time Earnings';
      else if(type==='winrate') title = 'Win Percentage (overall)';
      else if(type==='bjwinrate') title = 'Blackjack Win Percentage';
      else if(type==='pkwinrate') title = 'Poker Win Percentage';
      lbTitle.textContent = title;

      const arr = await loadUsersArrayFromDb();

      if(type==='earnings'){
        arr.sort((a,b)=>b.totalEarned-a.totalEarned);
      } else if(type==='winrate'){
        arr.sort((a,b)=>{
          const ra=a.games?(a.wins/a.games):0;
          const rb=b.games?(b.wins/b.games):0;
          return rb-ra;
        });
      } else if(type==='bjwinrate'){
        arr.sort((a,b)=>{
          const ra=a.bjGames?(a.bjWins/a.bjGames):0;
          const rb=b.bjGames?(b.bjWins/b.bjGames):0;
          return rb-ra;
        });
      } else if(type==='pkwinrate'){
        arr.sort((a,b)=>{
          const ra=a.pkGames?(a.pkWins/a.pkGames):0;
          const rb=b.pkGames?(b.pkWins/b.pkGames):0;
          return rb-ra;
        });
      }

      let html='';
      const top=arr.slice(0,10);
      top.forEach((u,i)=>{
        const isYou=currentUser && (u.key===currentUser.key);
        let extra = '';
        if(type==='earnings') extra = '‚Äî '+u.totalEarned+' credits';
        else if(type==='winrate') extra = '‚Äî '+(u.games?Math.round(100*u.wins/u.games):0)+'%';
        else if(type==='bjwinrate') extra = '‚Äî '+(u.bjGames?Math.round(100*u.bjWins/u.bjGames):0)+'%';
        else if(type==='pkwinrate') extra = '‚Äî '+(u.pkGames?Math.round(100*u.pkWins/u.pkGames):0)+'%';
        html+=`<div style="padding:6px 0">${i+1}. <strong>${u.name}</strong> ${isYou?'<em>(jij)</em>':''} ${extra}</div>`;
      });

      let yourRank=-1;
      if(currentUser) yourRank=arr.findIndex(x=>x.key===currentUser.key);
      if(yourRank>9){
        const u=arr[yourRank];
        let extra = '';
        if(type==='earnings') extra = '‚Äî '+u.totalEarned+' credits';
        else if(type==='winrate') extra = '‚Äî '+(u.games?Math.round(100*u.wins/u.games):0)+'%';
        else if(type==='bjwinrate') extra = '‚Äî '+(u.bjGames?Math.round(100*u.bjWins/u.bjGames):0)+'%';
        else if(type==='pkwinrate') extra = '‚Äî '+(u.pkGames?Math.round(100*u.pkWins/u.pkGames):0)+'%';
        html+=`<hr><div style="padding:6px 0">${yourRank+1}. <strong>${u.name}</strong> ${extra}</div>`;
      } else if(yourRank===-1 && currentUser){
        html+=`<hr><div style="padding:6px 0">Jij staat nog niet in de statistieken.</div>`;
      }
      lbContent.innerHTML=html;
    }

    lbTab.onclick = ()=>{ lbIndex=0; openLeaderboard(); };
    lbClose.onclick = ()=>{ lbPopup.style.display='none'; };
    lbLeft.onclick = ()=>{ lbIndex=(lbIndex-1+lbTypes.length)%lbTypes.length; openLeaderboard(); };
    lbRight.onclick = ()=>{ lbIndex=(lbIndex+1)%lbTypes.length; openLeaderboard(); };

  </script>
</body>
</html>
