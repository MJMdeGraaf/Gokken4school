<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Goksite PWS ‚Äî Multiplayer Blackjack & Poker (Online)</title>
  <style>
    /* ============================ LEADERBOARD TAB STYLE ============================ */
    #lb-tab{
        position: fixed;
        right: 20px;
        bottom: 20px;
        background: gold;
        padding: 12px 20px;
        border-radius: 16px;
        cursor: pointer;
        font-weight: bold;
        box-shadow: 0 0 10px rgba(0,0,0,0.4);
        z-index: 9999;
    }

    /* ============================ POPUP WINDOW ============================ */
    #lb-popup{
        position: fixed;
        bottom: 0;
        right: 0;
        width: 360px;
        height: 460px;
        background: rgba(0,0,0,0.88);
        border-radius: 20px 0 0 0;
        display: none;
        z-index: 99999;
        color: white;
    }

    #lb-popup-inner{
        padding: 18px;
        height: 100%;
        position: relative;
    }

    /* ============================ ARROWS ============================ */
    .lb-arrow{
        position: absolute;
        top: 12px;
        font-size: 26px;
        cursor: pointer;
        user-select: none;
    }
    #lb-left{ left: 10px; }
    #lb-right{ right: 10px; }

    /* ============================ CONTENT AREA ============================ */
    #lb-content{
        margin-top: 52px;
        height: 330px;
        overflow-y: auto;
        font-size: 16px;
    }

    #lb-close{
        position: absolute;
        bottom: 14px;
        left: 50%;
        transform: translateX(-50%);
        padding: 8px 20px;
        border-radius: 10px;
        cursor: pointer;
    }

    /* ============================ Music menu style ============================ */
    #musicMenu{
      position: fixed;
      right: 20px;
      bottom: 70px;
      width: 300px;
      background: rgba(0,0,0,0.92);
      color: white;
      padding: 15px;
      border-radius: 12px;
      display: none;
      z-index: 99999;
    }

    #musicMenuInner{
      text-align: center;
    }

    #musicMenu input[type=range]{
      width: 80%;
    }

    /* ============================ Rest of page ============================ */
    body { margin:0; font-family: system-ui, sans-serif; background:#111; color:#fff; }
    #login, #dashboard, #blackjackSection, #pokerSection { display: none; padding: 20px; text-align:center; }
    #login { background: radial-gradient(circle at top, #333, #000); height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center; gap:8px; color:#fff; }
    #dashboard { background: radial-gradient(circle at top, #222, #050505); height:100vh; color:#fff; position:relative; }
    #dashboard h2, #login h2 { margin-bottom:10px; }
    button { padding: 10px 14px; margin: 6px; border-radius: 8px; border:none; cursor:pointer; background:#d4af37; color:#111; font-weight:600; }

    /* credits badge */
    #creditsBadge {
      position:absolute;
      top:10px;
      left:10px;
      padding:8px 14px;
      border-radius:999px;
      background:rgba(0,0,0,0.7);
      color:#ffd700;
      font-weight:700;
      box-shadow:0 0 10px rgba(0,0,0,0.6);
      font-size:14px;
    }

    /* Blackjack sectie */
    #blackjackSection {
      background: radial-gradient(circle at top, #0b3b2e, #04110c);
      height:100vh;
      color:white;
      position:relative;
      overflow:hidden;
    }
    .table-container {
      position:relative;
      width: 90%;
      max-width: 900px;
      margin: 36px auto;
      height:520px;
    }
    .table {
      background: radial-gradient(circle at top, #145c3b, #052317);
      border-radius: 50%;
      width:100%;
      height:100%;
      position:relative;
      border: 10px solid #5e3b1e;
      box-shadow:
        0 20px 40px rgba(0,0,0,0.7),
        inset 0 0 40px rgba(0,0,0,0.8);
    }
    .table::before {
      content:"";
      position:absolute;
      inset:18%;
      border-radius:50%;
      border:3px solid rgba(255,215,0,0.35);
      box-shadow:0 0 18px rgba(255,215,0,0.35);
      pointer-events:none;
    }

    .player-area { position:absolute; text-align:center; color: white; transition: transform 0.2s ease, box-shadow 0.2s ease; }

    .player-area.active-player {
      transform: translateY(-6px) scale(1.05);
      box-shadow: 0 0 18px rgba(255, 215, 0, 0.65);
    }

    .cards { display:flex; justify-content:center; gap:8px; margin-top:8px; }
    .card-bj {
      width:80px;
      height:120px;
      border-radius:10px;
      background:linear-gradient(145deg,#fdfdfd,#f3f3f3);
      color:#111;
      border:2px solid #d4af37;
      display:flex;
      justify-content:center;
      align-items:center;
      font-weight:700;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      font-size:20px;
      box-shadow:
        0 6px 14px rgba(0,0,0,0.7),
        inset 0 0 0 1px rgba(255,255,255,0.8);
      position:relative;
      overflow:hidden;
      transition: transform 0.18s ease, box-shadow 0.18s ease;
    }
    .card-bj.card-back {
      background: radial-gradient(circle at 30% 20%, #fff8d0 0, #d4af37 35%, #8b6b1f 100%);
      box-shadow:
        0 6px 18px rgba(0,0,0,0.8),
        inset 0 0 0 1px rgba(255,255,255,0.9);
    }

    .chair { width:40px; height:40px; background:#333; border-radius:50%; position:absolute; box-shadow:inset 0 -4px 6px rgba(0,0,0,0.4); }
    #controls { margin-top:20px; }

    /* Poker sectie */
    #pokerSection {
      background: radial-gradient(circle at top, #162447, #050818);
      height:100vh;
      color:#fff;
      position:relative;
    }
    #pokerTable {
      position:relative;
      width:90%;
      max-width:900px;
      margin:40px auto;
      height:520px;
      background:radial-gradient(circle at top, #234, #020712);
      border-radius:40% / 60%;
      border: 10px solid #5e3b1e;
      box-shadow:
        0 20px 40px rgba(0,0,0,0.7),
        inset 0 0 40px rgba(0,0,0,0.8);
    }
    .poker-player {
      position:absolute;
      text-align:center;
      color:#fff;
    }
    .poker-cards {
      display:flex;
      justify-content:center;
      gap:6px;
      margin-top:4px;
    }
    .poker-card {
      width:60px;
      height:90px;
      background:#fff;
      border-radius:8px;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#000;
      font-weight:bold;
      box-shadow:0 4px 10px rgba(0,0,0,0.6);
    }
    #pokerControls {
      margin-top:10px;
    }

    /* small responsive */
    @media (max-width:600px){
      #lb-popup { width: 100%; right:0; left:0; height: 50vh; border-radius: 12px 12px 0 0;}
      .card-bj{ width:56px; height:84px; }
      .table-container{ height:360px; }
      #pokerTable{ height:360px; }
    }
  </style>
</head>
<body>

  <!-- Login / Account aanmaken -->
  <section id="login">
    <h2>Welkom! Maak een account of log in</h2>
    <input type="text" id="usernameInput" placeholder="Gebruikersnaam">
    <input type="password" id="passwordInput" placeholder="Wachtwoord">
    <button id="loginBtn">Login</button>
    <button id="createAccountBtn">Account aanmaken</button>
  </section>

  <!-- Dashboard -->
  <section id="dashboard">
    <div id="creditsBadge">üí∞ Credits: <span id="badgeCredits">0</span></div>
    <h2>Welkom, <span id="displayName"></span></h2>
    <p>Credits: <span id="credits"></span></p>
    <button id="claimDailyBtn">Claim dagelijkse bonus</button><br>
    <button id="playBlackjackBtn">Speel Blackjack</button>
    <button id="playPokerBtn">Speel Poker</button>
    <button id="logoutBtn">Uitloggen</button>

    <!-- Music control -->
    <div style="margin-top:12px;">
      <audio id="bgMusic" loop>
        <source src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_8f17fc4b42.mp3?filename=game-music-110387.mp3" type="audio/mpeg">
      </audio>
      <button id="musicControl">üéµ Muziek</button>
    </div>
  </section>

  <!-- Blackjack -->
  <section id="blackjackSection">
    <h2>Blackjack</h2>
    <div>
      <label>Kies aantal bots:</label>
      <select id="botCount">
        <option value="0">0 bots</option>
        <option value="1">1 bot</option>
        <option value="2">2 bots</option>
        <option value="3">3 bots</option>
        <option value="4">4 bots</option>
        <option value="5">5 bots</option>
        <option value="6">6 bots</option>
      </select><br><br>
      <label>Inzet (credits):</label>
      <input type="number" id="betAmount" min="1" value="100">
      <button id="startGame">Start spel</button>
      <button id="backToMenu">Terug naar menu</button>
    </div>
    <div class="table-container">
      <div class="table" id="table">
        <!-- Stoelen + spelergebieden komen hier dynamisch -->
      </div>
    </div>
    <div id="controls">
      <button id="hitBtn">Hit</button>
      <button id="standBtn">Stand</button>
      <button id="nextRoundBtn" style="display:none">Volgende ronde</button>
    </div>
  </section>

  <!-- Poker -->
  <section id="pokerSection">
    <h2>Texas Hold'em Poker</h2>
    <div>
      <label>Selecteer tafellimiet:</label>
      <select id="pokerTableLimit">
        <option value="500">500 credits</option>
        <option value="1500">1500 credits</option>
        <option value="3500">3500 credits</option>
        <option value="5000">5000 credits</option>
      </select>
      <button id="joinPokerBtn">Join tafel</button>
      <button id="leavePokerBtn">Verlaat tafel</button>
      <button id="backToMenuFromPoker">Terug naar menu</button>
    </div>
    <div id="pokerTable">
      <!-- Poker spelers + community cards -->
    </div>
    <div id="pokerControls">
      <button id="pokerCheckBtn">Check / Call</button>
      <button id="pokerBetBtn">Bet / Raise</button>
      <button id="pokerFoldBtn">Fold</button>
    </div>
  </section>

  <!-- Leaderboard floating tab -->
  <div id="lb-tab">üèÜ Leaderboard</div>

  <!-- Leaderboard popup -->
  <div id="lb-popup">
      <div id="lb-popup-inner">
          <div id="lb-left" class="lb-arrow">‚Üê</div>
          <h2 id="lb-title">All-Time Earnings</h2>
          <div id="lb-content"></div>
          <div id="lb-right" class="lb-arrow">‚Üí</div>
          <button id="lb-close">Sluiten</button>
      </div>
  </div>

  <!-- MUSIC MENU -->
  <div id="musicMenu">
    <div id="musicMenuInner">
        <h3>Muziekinstellingen</h3>
        <label>Volume:</label><br>
        <input type="range" id="musicVolume" min="0" max="1" step="0.01">
        <br><br>
        <label>Muziek selecteren:</label>
        <select id="musicTrackSelect">
            <option value="0">Funky Upbeat</option>
            <option value="1">Electronic Chill</option>
            <option value="2">Lounge Vibes</option>
        </select>
        <br><br>
        <button id="muteBtn">üéµ Mute</button>
        <br><br>
        <button id="closeMusicMenu">Sluiten</button>
    </div>
  </div>

  <!-- ============================ Firebase & App Script ============================ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyARtIFfUXzlkJppkcUSx5ril2FerJltwNs",
      authDomain: "gokken4school.firebaseapp.com",
      projectId: "gokken4school",
      storageBucket: "gokken4school.firebasestorage.app",
      messagingSenderId: "210902717668",
      appId: "1:210902717668:web:16ebea58067718ffce48f1",
      measurementId: "G-G9SVYLDMWC"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ==================== Data & helpers ====================
    let currentUser = null; 
    let currentUserId = null;

    async function loadUser(username) {
      const ref = doc(db, "users", username);
      const snap = await getDoc(ref);
      return snap.exists() ? snap.data() : null;
    }

    async function saveUser(username, data) {
      const ref = doc(db, "users", username);
      await setDoc(ref, data, { merge: true });
    }

    async function saveCurrentUser() {
      if (!currentUserId || !currentUser) return;
      await saveUser(currentUserId, currentUser);
    }

    // ==================== UI refs ====================
    const loginSection = document.getElementById('login');
    const dashboard = document.getElementById('dashboard');
    const blackjackSection = document.getElementById('blackjackSection');
    const pokerSection = document.getElementById('pokerSection');

    const usernameInput = document.getElementById('usernameInput');
    const passwordInput = document.getElementById('passwordInput');
    const loginBtn = document.getElementById('loginBtn');
    const createAccountBtn = document.getElementById('createAccountBtn');
    const displayName = document.getElementById('displayName');
    const creditsEl = document.getElementById('credits');
    const badgeCreditsEl = document.getElementById('badgeCredits');
    const claimDailyBtn = document.getElementById('claimDailyBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const playBlackjackBtn = document.getElementById('playBlackjackBtn');
    const playPokerBtn = document.getElementById('playPokerBtn');

    const bgMusic = document.getElementById('bgMusic');
    const musicControl = document.getElementById('musicControl');
    const musicMenu = document.getElementById('musicMenu');
    const musicVolume = document.getElementById('musicVolume');
    const musicTrackSelect = document.getElementById('musicTrackSelect');
    const closeMusicMenu = document.getElementById('closeMusicMenu');
    const muteBtn = document.getElementById('muteBtn');

    // Blackjack refs
    const startGameBtn = document.getElementById('startGame');
    const botSelect = document.getElementById('botCount');
    const betAmountInput = document.getElementById('betAmount');
    const table = document.getElementById('table');
    const hitBtn = document.getElementById('hitBtn');
    const standBtn = document.getElementById('standBtn');
    const nextRoundBtn = document.getElementById('nextRoundBtn');
    const backToMenuBtn = document.getElementById('backToMenu');

    // Poker refs
    const pokerTableLimit = document.getElementById('pokerTableLimit');
    const joinPokerBtn = document.getElementById('joinPokerBtn');
    const leavePokerBtn = document.getElementById('leavePokerBtn');
    const backToMenuFromPoker = document.getElementById('backToMenuFromPoker');
    const pokerTable = document.getElementById('pokerTable');
    const pokerCheckBtn = document.getElementById('pokerCheckBtn');
    const pokerBetBtn = document.getElementById('pokerBetBtn');
    const pokerFoldBtn = document.getElementById('pokerFoldBtn');

    // Leaderboard refs
    const lbTab = document.getElementById('lb-tab');
    const lbPopup = document.getElementById('lb-popup');
    const lbLeft = document.getElementById('lb-left');
    const lbRight = document.getElementById('lb-right');
    const lbClose = document.getElementById('lb-close');
    const lbTitle = document.getElementById('lb-title');
    const lbContent = document.getElementById('lb-content');

    function normalizeUsername(name){ return name.trim().toLowerCase(); }

    // ==================== Login ====================
    loginSection.style.display = 'flex';

    loginBtn.onclick = async ()=>{
        const nameRaw = usernameInput.value.trim();
        const password = passwordInput.value;
        if(!nameRaw || !password) return alert('Vul gebruikersnaam en wachtwoord in.');

        const key = normalizeUsername(nameRaw);
        const data = await loadUser(key);
        if(!data) return alert('Account bestaat niet.');
        if(data.password !== password) return alert('Wachtwoord verkeerd.');

        currentUserId = key;
        currentUser = data;
        showDashboard();
        try { bgMusic.play().catch(()=>{}); } catch(e){}
    };

    createAccountBtn.onclick = async ()=>{
        const nameRaw = usernameInput.value.trim();
        const password = passwordInput.value;
        if(!nameRaw || !password) return alert('Vul gebruikersnaam en wachtwoord in.');

        const key = normalizeUsername(nameRaw);
        const existing = await loadUser(key);
        if(existing) return alert('Account bestaat al.');

        currentUserId = key;
        currentUser = {
            name: nameRaw,
            password: password,
            credits: 500,
            lastDaily: null,
            wins: 0,
            losses: 0,
            totalEarned: 0,
            gamesPlayed: 0
        };

        await saveCurrentUser();
        showDashboard();
        try { bgMusic.play().catch(()=>{}); } catch(e){}
    };

    function showDashboard(){
      loginSection.style.display = 'none';
      blackjackSection.style.display = 'none';
      pokerSection.style.display = 'none';
      dashboard.style.display = 'block';
      renderDashboard();
    }

    function renderDashboard(){
      if(!currentUser) return;
      displayName.textContent = currentUser.name;
      creditsEl.textContent = currentUser.credits;
      badgeCreditsEl.textContent = currentUser.credits;
    }

    logoutBtn.onclick = () => {
      currentUser = null;
      currentUserId = null;
      dashboard.style.display = 'none';
      blackjackSection.style.display = 'none';
      pokerSection.style.display = 'none';
      loginSection.style.display = 'flex';
      bgMusic.pause();
    };

    claimDailyBtn.onclick = async ()=>{
      if(!currentUser) return;
      const t = new Date().toDateString();
      if(currentUser.lastDaily !== t){
        currentUser.credits += 100;
        currentUser.lastDaily = t;
        await saveCurrentUser();
        renderDashboard();
        alert('Dagelijkse bonus geclaimd: +100 credits');
      } else {
        alert('Je hebt vandaag al je bonus geclaimd.');
      }
    };

    playBlackjackBtn.onclick = ()=>{
      dashboard.style.display='none';
      pokerSection.style.display='none';
      blackjackSection.style.display='block';
    };

    playPokerBtn.onclick = ()=>{
      dashboard.style.display='none';
      blackjackSection.style.display='none';
      pokerSection.style.display='block';
    };

    backToMenuBtn.onclick = ()=>{
      blackjackSection.style.display='none';
      showDashboard();
    };

    backToMenuFromPoker.onclick = ()=>{
      pokerSection.style.display='none';
      showDashboard();
    };

    // ==================== Music menu ====================
    musicVolume.value = 0.4;
    bgMusic.volume = 0.4;

    musicControl.onclick = () => { musicMenu.style.display = (musicMenu.style.display==='block'?'none':'block'); };
    musicVolume.oninput = ()=>{ bgMusic.volume = parseFloat(musicVolume.value); };
    musicTrackSelect.onchange = ()=>{
      const index = parseInt(musicTrackSelect.value);
      const sources = bgMusic.querySelectorAll('source');
      if(sources[index]){
        bgMusic.pause();
        bgMusic.src = sources[index].src;
        bgMusic.load();
        bgMusic.play().catch(()=>{});
      }
    };
    muteBtn.onclick = ()=>{ bgMusic.muted = !bgMusic.muted; muteBtn.textContent = bgMusic.muted ? 'üîá Unmute' : 'üéµ Mute'; };
    closeMusicMenu.onclick = ()=>{ musicMenu.style.display='none'; };

    // ==================== Blackjack logic ====================
    const suits=['‚ô†','‚ô•','‚ô¶','‚ô£'];
    const values=['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
    let deck=[];

    function createDeck(){
      deck=[];
      for(let s of suits) for(let v of values) deck.push({suit:s, value:v});
      for(let i=deck.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [deck[i],deck[j]]=[deck[j],deck[i]]; }
    }
    function cardValue(card){ if(['J','Q','K'].includes(card.value)) return 10; if(card.value==='A') return 11; return parseInt(card.value); }
    function handValue(hand){ let total=0, aces=0; for(let c of hand){ total+=cardValue(c); if(c.value==='A') aces++; } while(total>21 && aces>0){ total-=10; aces--; } return total; }
    function drawCard(){ return deck.pop(); }

    let players=[]; // includes human and bots
    let dealer={hand:[], name:'Dealer'};
    let currentPlayerIndex=0;
    let currentBet = 100;
    let dealerReveal = false;

    function placePlayers() {
      table.innerHTML = '';

      const centerX = table.clientWidth / 2;
      const centerY = table.clientHeight / 2;
      const cardW = 80;
      const cardH = 120;

      // binnenradius: dealer & speler, iets binnen de rand
      const innerRadius = Math.min(centerX, centerY) - 120;

      // buitenradius: bots, precies op de rand van de tafel
      const outerRadius = Math.min(centerX, centerY) - 70;

      // hoeken: dealer boven (12 uur), speler onder (6 uur)
      const dealerAngle = -Math.PI / 2;
      const playerAngle =  Math.PI / 2;

      const botCount = Math.max(0, players.length - 1);

      function getPos(radius, angle) {
        return {
          x: centerX + radius * Math.cos(angle) - cardW / 2,
          y: centerY + radius * Math.sin(angle) - cardH / 2
        };
      }

      function createPlayerArea(label, hand, angle, radius, isActive) {
        const pos = getPos(radius, angle);

        const div = document.createElement('div');
        div.className = 'player-area';
        if (isActive) div.classList.add('active-player');
        div.style.left = pos.x + 'px';
        div.style.top = pos.y + 'px';

        const cardsHTML = hand.map(c =>
          `<div class="card-bj">${c.value}${c.suit}</div>`
        ).join('');

        div.innerHTML = `
          <h3>${label}</h3>
          <div class="cards">${cardsHTML}</div>
          <p>Score: ${handValue(hand)}</p>
        `;

        table.appendChild(div);
      }

      // Dealer (nooit actief)
      // Dealer met hole card: eerste kaart face-down als dealerReveal nog false is
      (function(){
        const radius = innerRadius;
        const angle = dealerAngle;
        const pos = {
          x: centerX + radius * Math.cos(angle) - cardW / 2,
          y: centerY + radius * Math.sin(angle) - cardH / 2
        };
        const div = document.createElement('div');
        div.className = 'player-area';
        div.style.left = pos.x + 'px';
        div.style.top = pos.y + 'px';

        let cardsHTML = '';
        if (!dealerReveal && dealer.hand.length > 0) {
          // eerste kaart rug, tweede kaart open
          cardsHTML += `<div class="card-bj card-back"></div>`;
          for (let i = 1; i < dealer.hand.length; i++) {
            const c = dealer.hand[i];
            cardsHTML += `<div class="card-bj">${c.value}${c.suit}</div>`;
          }
        } else {
          cardsHTML = dealer.hand.map(c => `<div class="card-bj">${c.value}${c.suit}</div>`).join('');
        }

        const scoreText = dealerReveal ? handValue(dealer.hand) : '?';

        div.innerHTML = `
          <h3>Dealer</h3>
          <div class="cards">${cardsHTML}</div>
          <p>Score: ${scoreText}</p>
        `;
        table.appendChild(div);
      })();

      // Speler (altijd players[0])
      if (players.length > 0) {
        const isActivePlayer = currentPlayerIndex === 0;
        createPlayerArea(players[0].name, players[0].hand, playerAngle, innerRadius, isActivePlayer);
      }

      // Bots langs de rand, gelijk verdeeld over 360¬∞
      if (botCount > 0) {
        for (let i = 1; i < players.length; i++) {
          const botIndex = i - 1;                // 0..botCount-1
          const angle = (2 * Math.PI * botIndex / botCount) - Math.PI / 2; // rondom, start boven
          const isActiveBot = currentPlayerIndex === i;
          createPlayerArea(players[i].name, players[i].hand, angle, outerRadius, isActiveBot);
        }
      }
    }

    function renderGame(){
      placePlayers();
    }

    function nextPlayer(){
      currentPlayerIndex++;
      if(currentPlayerIndex >= players.length){
        dealerTurn();
      } else if(players[currentPlayerIndex].bot){
        botTurn(players[currentPlayerIndex]);
      }
      renderGame();
    }

    function botTurn(bot){
      let hv = handValue(bot.hand);
      while(hv<16){
        bot.hand.push(drawCard());
        hv=handValue(bot.hand);
      }
      nextPlayer();
    }

    function dealerTurn(){
      dealerReveal = true;
      renderGame();
      let hv = handValue(dealer.hand);
      while(hv<17){
        dealer.hand.push(drawCard());
        hv=handValue(dealer.hand);
      }
      renderGame();
      checkWinners();
    }

    async function checkWinners(){
      const dealerScore=handValue(dealer.hand);
      let resultMsg=`Dealer heeft ${dealerScore}.\n`;

      for(let i=0;i<players.length;i++){
        const p=players[i];
        const ps=handValue(p.hand);
        let outcome='lose';
        if(ps>21){
          resultMsg+=`${p.name} verliest (bust).\n`;
          outcome='lose';
        } else if(dealerScore>21 || ps>dealerScore){
          resultMsg+=`${p.name} wint!\n`;
          outcome='win';
        } else if(ps===dealerScore){
          resultMsg+=`${p.name} gelijkspel.\n`;
          outcome='push';
        } else{
          resultMsg+=`${p.name} verliest.\n`;
          outcome='lose';
        }

        if(i===0 && currentUser){
          let delta = 0;
          if(outcome==='win') delta = Math.floor(currentBet*1.5);
          else if(outcome==='push') delta = Math.floor(currentBet*1.0);
          else delta = 0;

          currentUser.credits += delta;
          currentUser.gamesPlayed = (currentUser.gamesPlayed||0)+1;
          if(outcome==='win'){ currentUser.wins=(currentUser.wins||0)+1; currentUser.totalEarned=(currentUser.totalEarned||0)+delta; }
          else if(outcome==='lose'){ currentUser.losses=(currentUser.losses||0)+1; }
          await saveCurrentUser();
          renderDashboard();
        }
      }

      alert(resultMsg);
      nextRoundBtn.style.display='inline';
      hitBtn.style.display='none';
      standBtn.style.display='none';
    }

    function startRound(){
      if(!currentUser) return;
      const requestedBet = parseInt(betAmountInput.value)||100;
      if(currentUser.credits < requestedBet){
        alert('Je hebt niet genoeg credits voor deze inzet.');
        return;
      }
      currentBet = requestedBet;
      currentUser.credits -= currentBet;
      saveCurrentUser().then(renderDashboard);

      createDeck();
      dealer.hand=[drawCard(), drawCard()];
      players.forEach(p=>p.hand=[drawCard(), drawCard()]);
      currentPlayerIndex=0;
      dealerReveal = false;
      renderGame();
      if(players[0].bot) botTurn(players[0]);
      hitBtn.style.display='inline';
      standBtn.style.display='inline';
    }

    startGameBtn.onclick = ()=>{
      if(!currentUser) return alert('Je moet eerst inloggen!');
      const botCount=parseInt(botSelect.value);
      players=[{ name:currentUser.name, bot:false, hand:[] }];
      for(let i=1;i<=botCount;i++) players.push({ name:`Bot ${i}`, bot:true, hand:[] });
      startRound();
    };

    hitBtn.onclick = ()=>{
      const p = players[currentPlayerIndex];
      p.hand.push(drawCard());
      if(handValue(p.hand)>21) nextPlayer();
      renderGame();
    };

    standBtn.onclick = ()=>{ nextPlayer(); };
    nextRoundBtn.onclick = ()=>{ nextRoundBtn.style.display='none'; startRound(); };

    // ==================== Leaderboard popup ====================
    let lbIndex = 0;
    const lbTypes = ['earnings','winrate'];
    async function loadUsersArray(){
      const snap = await getDocs(collection(db, "users"));
      const arr = [];
      snap.forEach(docSnap => {
        const u = docSnap.data();
        arr.push({
          key: docSnap.id,
          name: u.name,
          totalEarned: u.totalEarned||0,
          wins: u.wins||0,
          losses: u.losses||0,
          games: u.gamesPlayed||0
        });
      });
      return arr;
    }

    async function openLeaderboard(){
      lbPopup.style.display='block';
      const type = lbTypes[lbIndex];
      lbTitle.textContent = type==='earnings'?'All-Time Earnings':'Win Percentage';
      const arr=await loadUsersArray();
      if(type==='earnings'){ arr.sort((a,b)=>b.totalEarned-a.totalEarned); }
      else { arr.sort((a,b)=>{ const ra=a.games?(a.wins/a.games):0; const rb=b.games?(b.wins/b.games):0; return rb-ra; }); }
      let html='';
      const top=arr.slice(0,10);
      top.forEach((u,i)=>{ 
        const isYou=currentUserId && (u.key===currentUserId); 
        html+=`<div style="padding:6px 0">${i+1}. <strong>${u.name}</strong> ${isYou?'<em>(jij)</em>':''} ${type==='earnings'?('‚Äî '+u.totalEarned+' credits'):('‚Äî '+(u.games?Math.round(100*u.wins/u.games):0)+'%')}</div>`; 
      });
      let yourRank=-1; if(currentUserId){ yourRank=arr.findIndex(x=>x.key===currentUserId); }
      if(yourRank>9){ const u=arr[yourRank]; html+=`<hr><div style="padding:6px 0">${yourRank+1}. <strong>${u.name}</strong> ${type==='earnings'?('‚Äî '+u.totalEarned+' credits'):('‚Äî '+(u.games?Math.round(100*u.wins/u.games):0)+'%')}</div>`; }
      else if(yourRank===-1 && currentUserId){ html+=`<hr><div style="padding:6px 0">Jij staat nog niet in de statistieken.</div>`; }
      lbContent.innerHTML=html;
    }

    lbTab.onclick = ()=>{ lbIndex=0; openLeaderboard(); };
    lbClose.onclick = ()=>{ lbPopup.style.display='none'; };
    lbLeft.onclick = ()=>{ lbIndex=(lbIndex-1+lbTypes.length)%lbTypes.length; openLeaderboard(); };
    lbRight.onclick = ()=>{ lbIndex=(lbIndex+1)%lbTypes.length; openLeaderboard(); };

  </script>
</body>
</html>
